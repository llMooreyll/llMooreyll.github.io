<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Markdown to Html</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@100;300;400;500;700;900&family=Rubik+Dirt&family=Rubik+Mono+One&display=swap" rel="stylesheet">
        <link href="./assets/css/main.css" rel="stylesheet" />
        <link href="./assets/css/github-markdown.css" rel="stylesheet" />
        <link href="./assets/css/MdPassage.css" rel="stylesheet" />
        <script src="./assets/js/markdown-it.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-light.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/highlightjs-line-numbers.js/dist/highlightjs-line-numbers.min.js"></script>
        <script src="./assets/js/MdToHtm.js" defer="defer"></script>
        <script src="./assets/js/parallax.js" type="text/javascript" defer="defer"></script>
        <script>
            hljs.highlightAll();
            hljs.initLineNumbersOnLoad ({ singleLine:true });
        </script>
    </head>

    <body>
        <nav class="navbar navbar-expand-lg navbar-light fixed-top semi-transparent">
            <div class="secondary-container container" style="top: 0%">
                <a class="navbar-brand" href="./index.html"><strong>Orey's</strong><sub style="font-size: 20px">Blog </sub></a>
                <div class="navbar-collapse collapse" id="navbarColor02">
                    <ul class="navbar-nav mr-auto d-flex align-items-center">
                        <li class="nav-item">
                            <a class="nav-link btn" href="./index.html">Home <span class="sr-only">(current)</span></a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link btn" href=" ">Projects</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link btn" href=" ">Collections</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link btn" href=" ">About</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        <!-- HEADER -->
        <div class="container-top">
            <div
                class="passage-head-image head-image"
                id="parallax-img"
                style="
                    background-image: url(./assets/img/markdown/729CC8A01DFD4BB2A8B226767A2FA212.jpg);
                    transform: translate3d(0, 0, 0);
                    background-size: cover;
                    background-repeat: no-repeat;
                "
            ></div>
            <div class="passage-wrapper wrapper">
                <div class="post-header">
                    <h1 id="passageTitle" class="post-title" style="font-size: 80px;">前端实现markdown的解析<br/>及根据文章结构生成目录</h1>
                    <h2 class="post-secondary-title">
                    </h2>
                    <span class="post-meta"><i>Posted by Moorey on July 21, 2023</i></span>
                </div>
            </div>
        </div>
        <!-- End Header -->
        <div class="markdown-body" id="markdown-body">
            <h1 id="passageTitleCopy" style="position: absolute; top: -1000px;"></h1>
            <div id="raw-markdown-body">

## 将markdown语法的内容转换为html格式的文件

### 引入markdown-it及其他准备

- [markdown-it](https://github.com/markdown-it/markdown-it)是目前使用最广泛的markdown解析器之一, 使用它非常简单, 首先将它引入,如下:  
```HTML
&lt;!-- jsDeliver CDN -->
&lt;script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js">&lt;/script>
&lt;!-- cdnjs.com CDN -->
&lt;script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js">&lt;/script>
```
或直接将 `markdown-it.min.js` 文件下载下来引用:  
```HTML
&lt;script src="./assets/js/markdown-it.min.js">&lt;/script>
```

- 准备HTML文件如下:  

```HTML
&lt;!DOCTYPE html>
&lt;html>
    &lt;head>
        &lt;meta charset="utf-8" />
        &lt;title>Markdown to Html&lt;/title>
        &lt;!-- 引入markdown-it.js -->
        &lt;script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js">&lt;/script>
        &lt;!-- 调用markdown-it.js解析md格式原文,内容见后文 -->
        &lt;script src="./assets/js/MdToHtm.js" defer="defer">&lt;/script>
    &lt;/head>
    &lt;body>
        &lt;div class="markdown-body" id="raw-markdown-body">
        &lt;!-- markdown格式内容 -->
        &lt;/div>
    &lt;/body>
&lt;/html>
```

### 使用markdown-it解析md原文

- `MdToHtm.js` 文件内容如下:

```JAVASCRIPT
{
    //加载markdown-it
    let MarkdownIt = window.markdownit({
        html: true,//启用解析md原文中html标签的功能
        linkify: true,//启用将类似url格式的文本解析为链接的功能
        typographer: true,//启用对一些符号进行替换的功能
        //另还有xhtmlOut, breaks, langPrefix, quotes等选项可以调整
        //详见文档 https://markdown-it.github.io/markdown-it/
    });

    //获取html文件中md格式原文
    let text = document.querySelector('#raw-markdown-body').textContent,
        //获取解析后的html格式文本应传入的目标节点
        target = document.querySelector('#raw-markdown-body'),
        //调用函数解析md原文
        result = MarkdownIt.render(text);
    //解析后的html格式文本传入目标节点
    target.innerHTML = result;
}
```
- 在 [github-markdown-css](https://github.com/sindresorhus/github-markdown-css) 下载`github-markdown.css` 样式文件引入：
```HTML
        &lt;link href="./assets/css/github-markdown.css" rel="stylesheet" />
```

## 根据文章结构生成目录

### 遍历返回的html格式文本中的所有节点

- 遍历节点函数如下:

```JAVASCRIPT
//传入两个参数，第一个参数为被遍历节点，第二个参数为一个处理节点并生成目录的函数，定义见后文
function nodeTraverse(e, f) {
    //首先处理父节点
    f(e);
    //如果父节点有子节点
    if (e.hasChildNodes()) {
        //将父节点的所有子节点收集起来，e.childNodes返回一个nodeList类数组对象
        let children = e.childNodes;
        //遍历刚刚得到的子节点列表
        for (let i = 0; i < children.length; i++) {
            //递归，对每个子节点重复执行上述操作
            nodeTraverse(children[i], f);
        }
    }
}
```

### 匹配H1，H2，H3节点并生成目录

- 接下来处理上一部函数遍历到的每个节点:
```JAVASCRIPT
//要匹配的html标签名
let titleTag = ['H1', 'H2', 'H3'];
//准备收集匹配到的节点
let titles = [];
//传给遍历函数第一个参数的父节点
let nodeToBeTraversed = document.querySelector('#markdown-body');

//传入一个节点
function generateIndex(e) {
    //传入的节点是否是'H1'或'H2'或'H3'
    if (titleTag.includes(e.nodeName)) {
        //获取该节点内的文本
        let result = e.textContent;
        //将该节点的'id'属性设为其文本内容，方便使用<a>锚点跳转
        e.setAttribute('id', result);
        //将该节点相关信息放入'titles'收集起来
        titles.push({
            //该节点的'id'标签及其值用于<a>锚点跳转
            id: result,
            //取该节点的节点名最后一位以提供缩进信息，如'H1'取'1','H2'取'2'
            level: e.nodeName.substring(1),
            //该节点文本内容
            title: result,
        });
    }
}
```
- Html文件中加入：

```HTML
&lt;div id="category">&lt;/div>
```

- 调用函数并使用 `titles` 中的信息拼接生成目录
```JAVASCRIPT
//调用函数得到 'titles' 数组
nodeTraverse(nodeToBeTraversed, generateIndex);

//使用 'titles' 数组中的信息拼接生成目录
for (let index in titles) {
        document.querySelector('#category').innerHTML +=
            //根据'level'设置缩进
            "&lt;li class='index' style='padding-left: " + titles[index].level * 22 + "px;'>" +
            //根据'id'设置跳转锚点
            "&lt;a href='#" + titles[index].id + "'>" +
            //根据'title'设置文本内容
            titles[index].title +
            '&lt;/a>&lt;/li>';
}
```

- 简单设置样式：
```CSS

#category {
    position: fixed;
    right: 4%;
    top: 35%;
    transition: 0.2s;
}

.index{
    margin: 10px 10px 10px 15px;
    font-size: 15px;
    font-weight: bolder;
    list-style-type: none;
}

#category a {
    text-decoration: none;
    color: #00000065;
    transition: 0.5s;
}

/* 状态三: 鼠标划过(停留)的链接(默认红色) */
#category a:hover {
    text-decoration: none;
    color: #000000;
    transition: 0.5s;
}

```

## 完整代码如下：

### index.html 文件如下:

```HTML
&lt;!DOCTYPE html>
&lt;html>
    &lt;head>
        &lt;meta charset="utf-8" />
        &lt;title>Markdown to Html&lt;/title>
        &lt;!-- 引入markdown-it.js -->
        &lt;script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js">&lt;/script>
        &lt;!-- 引入样式表文件 -->
        &lt;link href="./assets/css/github-markdown.css" rel="stylesheet" />
        &lt;!-- 调用markdown-it.js解析md格式原文,内容见后文 -->
        &lt;script src="./assets/js/MdToHtm.js" defer="defer">&lt;/script>
    &lt;/head>
    &lt;body>
        &lt;div class="markdown-body" id="raw-markdown-body">
        &lt;!-- markdown格式内容 -->
        &lt;/div>
        &lt;div id="category">&lt;/div>
    &lt;/body>
&lt;/html>
```

### MdToHtm.js 文件如下:
```JAVASCRIPT
//将markdown语法的内容转换为html格式的文件
{
    //加载markdown-it
    let MarkdownIt = window.markdownit({
        html: true,//启用解析md原文中html标签的功能
        linkify: true,//启用将类似url格式的文本解析为链接的功能
        typographer: true,//启用对一些符号进行替换的功能
        //另还有xhtmlOut, breaks, langPrefix, quotes等选项可以调整
        //详见文档 https://markdown-it.github.io/markdown-it/
    });

    //获取html文件中md格式原文
    let text = document.querySelector('#raw-markdown-body').textContent,
        //获取解析后的html格式文本应传入的目标节点
        target = document.querySelector('#raw-markdown-body'),
        //调用函数解析md原文
        result = MarkdownIt.render(text);
    //解析后的html格式文本传入目标节点
    target.innerHTML = result;
}

//根据文章结构生成目录
{
    //要匹配的html标签名
    let titleTag = ['H1', 'H2', 'H3'];
    //准备收集匹配到的节点
    let titles = [];
    //传给遍历函数第一个参数的父节点
    let nodeToBeTraversed = document.querySelector('#markdown-body');

    //传入两个参数，第一个参数为被遍历节点，第二个参数为一个处理节点并生成目录的函数，定义见后文
    function nodeTraverse(e, f) {
        //首先处理父节点
        f(e);
        //如果父节点有子节点
        if (e.hasChildNodes()) {
            //将父节点的所有子节点收集起来，e.childNodes返回一个nodeList类数组对象
            let children = e.childNodes;
            //遍历刚刚得到的子节点列表
            for (let i = 0; i < children.length; i++) {
                //递归，对每个子节点重复执行上述操作
                nodeTraverse(children[i], f);
            }
        }
    }

    //传入一个节点
    function generateIndex(e) {
        //传入的节点是否是'H1'或'H2'或'H3'
        if (titleTag.includes(e.nodeName)) {
            //获取该节点内的文本
            let result = e.textContent;
            //将该节点的'id'属性设为其文本内容，方便使用<a>锚点跳转
            e.setAttribute('id', result);
            //将该节点相关信息放入'titles'收集起来
            titles.push({
                //该节点的'id'标签及其值用于<a>锚点跳转
                id: result,
                //取该节点的节点名最后一位以提供缩进信息，如'H1'取'1','H2'取'2'
                level: e.nodeName.substring(1),
                //该节点文本内容
                title: result,
            });
        }
    }

    nodeTraverse(nodeToBeTraversed, generateIndex);

    //使用 'titles' 数组中的信息拼接生成目录
    for (let index in titles) {
            document.querySelector('#category').innerHTML +=
                //根据'level'设置缩进
                "&lt;li class='index' style='padding-left: " + titles[index].level * 22 + "px;'>" +
                //根据'id'设置跳转锚点
                "&lt;a href='#" + titles[index].id + "'>" +
                //根据'title'设置文本内容
                titles[index].title +
                '&lt;/a>&lt;/li>';
    }
}
```

### MdPassage.css 文件如下:

```CSS

#category {
    position: fixed;
    right: 4%;
    top: 35%;
    transition: 0.2s;
}

.index{
    margin: 10px 10px 10px 15px;
    font-size: 15px;
    font-weight: bolder;
    list-style-type: none;
}

#category a {
    text-decoration: none;
    color: #00000065;
    transition: 0.5s;
}

/* 状态三: 鼠标划过(停留)的链接(默认红色) */
#category a:hover {
    text-decoration: none;
    color: #000000;
    transition: 0.5s;
}

```

### github-markdown.css 文件

见 https://github.com/sindresorhus/github-markdown-css

## 附录

### 常用html转义字符:


|  字符   | 十进制  | 转义字符  |
|  ----  | ----  | ----  |
| "  | &amp;#34\; | &amp;quot\; |
| &  | &amp;#38\; | &amp;amp\; |
| &lt;  | &amp;#60\; | &amp;lt\; |


            </div>
        </div>
        <div id="category"></div>
        <!-- <div id="currentlyReading" style="min-height: 60px; width: 100%; position: fixed; top: 35%; background-color: aliceblue;"></div> -->
    </body>
</html>
