<!-- 重做的文章页面 -->
<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Markdown to Html</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <!-- MDUI CSS -->
        <link rel="stylesheet" href="https://unpkg.com/mdui@1.0.2/dist/css/mdui.min.css" />
        <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@100;300;400;500;700;900&family=Rubik+Dirt&family=Rubik+Mono+One&display=swap" rel="stylesheet">
        <link href="./assets/css/github-markdown.css" rel="stylesheet" />
        <script src="./assets/js/markdown-it.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-light.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/highlightjs-line-numbers.js/dist/highlightjs-line-numbers.min.js"></script>
        <script src="./assets/js/MdToHtm.js" defer="defer"></script>
        <script src="./assets/js/parallax.js" type="text/javascript" defer="defer"></script>
        <!-- MDUI JavaScript -->
        <script src="https://unpkg.com/mdui@1.0.2/dist/js/mdui.min.js"></script>
        <!-- Main CSS -->
        <link rel="stylesheet" href="./assets/css/main_test.css" />
        <script src="./assets/js/test.js" defer></script>
        <link href="./assets/css/MdPassage.css" rel="stylesheet" />
        <script>
            hljs.highlightAll();
            hljs.initLineNumbersOnLoad ({ singleLine:true });
        </script>
    </head>

    <body class="mdui-theme-primary-indigo mdui-theme-accent-pink">
        <!-- NAVBAR -->
        <nav class="mdui-toolbar mdui-color-theme mdui-shadow-12 mdui-appbar-fixed" style="z-index: 528">
            <button class="mdui-btn mdui-btn-icon" id="openLeftDrawer">
                <i class="mdui-icon material-icons">menu</i>
            </button>
            <a class="mdui-typo-title" href="./index.html">
                <strong style="font-size: 25px">Orey's</strong>
                <sub class="mdui-text-capitalize" style="font-size: 15px">Blog</sub>
            </a>
            <div class="mdui-toolbar-spacer"></div>
            <a
                href="https://github.com/llMooreyll/llMooreyll.github.io"
                target="_blank"
                class="mdui-btn mdui-btn-icon mdui-ripple mdui-ripple-white"
                mdui-tooltip="{content: 'About'}"
            >
                <svg xmlns="http://www.w3.org/2000/svg" style="width: 24px; height: 24px" fill="currentColor" class="mdui-icon" viewBox="0 0 16 16">
                    <path
                        d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"
                    />
                </svg>
            </a>
        </nav>

        <div class="mdui-drawer mdui-drawer-close mdui-color-white" id="left-drawer">
            <ul class="mdui-list">
                <li class="mdui-list-item mdui-ripple">
                    <i class="mdui-list-item-icon mdui-icon material-icons">&#xe88a;</i>
                    <a class="mdui-list-item-content"  href="./index.html">Home</a>
                </li>
                <li class="mdui-list-item mdui-ripple">
                    <i class="mdui-list-item-icon mdui-icon material-icons">&#xe2c7;</i>
                    <div class="mdui-list-item-content">Projects</div>
                </li>
                <li class="mdui-list-item mdui-ripple">
                    <i class="mdui-list-item-icon mdui-icon material-icons">&#xe149;</i>
                    <div class="mdui-list-item-content">Collections</div>
                </li>
                <li class="mdui-list-item mdui-ripple">
                    <i class="mdui-list-item-icon mdui-icon material-icons">&#xe853;</i>
                    <div class="mdui-list-item-content">About</div>
                </li>
                <li class="mdui-subheader">Subheader</li>
                <li class="mdui-list-item mdui-ripple">
                    <i class="mdui-list-item-icon mdui-icon material-icons">email</i>
                    <div class="mdui-list-item-content">All mail</div>
                </li>
                <li class="mdui-list-item mdui-ripple">
                    <i class="mdui-list-item-icon mdui-icon material-icons">delete</i>
                    <div class="mdui-list-item-content">Trash</div>
                </li>
                <li class="mdui-list-item mdui-ripple">
                    <i class="mdui-list-item-icon mdui-icon material-icons">error</i>
                    <div class="mdui-list-item-content">Spam</div>
                </li>
            </ul>
        </div>
        <!-- HEADER -->
        <div class="container-top">
            <div
                class="passage-head-image head-image"
                id="parallax-img"
                style="
                    background-image: url(./assets/img/markdown/729CC8A01DFD4BB2A8B226767A2FA212.jpg);
                    transform: translate3d(0, 0, 0);
                    background-size: cover;
                    background-repeat: no-repeat;
                "
            ></div>
            <div class="passage-wrapper wrapper">
                <div class="post-header">
                    <h1 id="passageTitle" class="post-title" style="font-size: 80px;">前端实现markdown的解析<br/>及根据文章结构生成目录</h1>
                    <h2 class="post-secondary-title">
                    </h2>
                    <span class="post-meta"><i>Posted by Moorey on July 21, 2023</i></span>
                </div>
            </div>
        </div>
        <!-- End Header -->
        <div class="markdown-body" id="markdown-body">
            <h1 id="passageTitleCopy" style="position: absolute; top: -1000px;"></h1>
            <div id="raw-markdown-body">

## 将markdown语法的内容转换为html格式的文件

### 引入markdown-it及其他准备

- [markdown-it](https://github.com/markdown-it/markdown-it)是目前使用最广泛的markdown解析器之一, 使用它非常简单, 首先将它引入,如下:  
```HTML
&lt;!-- jsDeliver CDN -->
&lt;script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js">&lt;/script>
&lt;!-- cdnjs.com CDN -->
&lt;script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js">&lt;/script>
```
或直接将 `markdown-it.min.js` 文件下载下来引用:  
```HTML
&lt;script src="./assets/js/markdown-it.min.js">&lt;/script>
```

- 准备HTML文件如下:  

```HTML
&lt;!DOCTYPE html>
&lt;html>
    &lt;head>
        &lt;meta charset="utf-8" />
        &lt;title>Markdown to Html&lt;/title>
        &lt;!-- 引入markdown-it.js -->
        &lt;script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js">&lt;/script>
        &lt;!-- 调用markdown-it.js解析md格式原文,内容见后文 -->
        &lt;script src="./assets/js/MdToHtm.js" defer="defer">&lt;/script>
    &lt;/head>
    &lt;body>
        &lt;div class="markdown-body" id="raw-markdown-body">
        &lt;!-- markdown格式内容 -->
        &lt;/div>
    &lt;/body>
&lt;/html>
```

### 使用markdown-it解析md原文

- `MdToHtm.js` 文件内容如下:

```JAVASCRIPT
{
    //加载markdown-it
    let MarkdownIt = window.markdownit({
        html: true,//启用解析md原文中html标签的功能
        linkify: true,//启用将类似url格式的文本解析为链接的功能
        typographer: true,//启用对一些符号进行替换的功能
        //另还有xhtmlOut, breaks, langPrefix, quotes等选项可以调整
        //详见文档 https://markdown-it.github.io/markdown-it/
    });

    //获取html文件中md格式原文
    let text = document.querySelector('#raw-markdown-body').textContent,
        //获取解析后的html格式文本应传入的目标节点
        target = document.querySelector('#raw-markdown-body'),
        //调用函数解析md原文
        result = MarkdownIt.render(text);
    //解析后的html格式文本传入目标节点
    target.innerHTML = result;
}
```
- 在 [github-markdown-css](https://github.com/sindresorhus/github-markdown-css) 下载`github-markdown.css` 样式文件引入：
```HTML
        &lt;link href="./assets/css/github-markdown.css" rel="stylesheet" />
```

## 根据文章结构生成目录

### 遍历返回的html格式文本中的所有节点

- 遍历节点函数如下:

```JAVASCRIPT
//传入两个参数，第一个参数为被遍历节点，第二个参数为一个处理节点并生成目录的函数，定义见后文
function nodeTraverse(e, f) {
    //首先处理父节点
    f(e);
    //如果父节点有子节点
    if (e.hasChildNodes()) {
        //将父节点的所有子节点收集起来，e.childNodes返回一个nodeList类数组对象
        let children = e.childNodes;
        //遍历刚刚得到的子节点列表
        for (let i = 0; i < children.length; i++) {
            //递归，对每个子节点重复执行上述操作
            nodeTraverse(children[i], f);
        }
    }
}
```

### 匹配H1，H2，H3节点并生成目录

- 接下来处理上一部函数遍历到的每个节点:
```JAVASCRIPT
//要匹配的html标签名
let titleTag = ['H1', 'H2', 'H3'];
//准备收集匹配到的节点
let titles = [];
//传给遍历函数第一个参数的父节点
let nodeToBeTraversed = document.querySelector('#markdown-body');

//传入一个节点
function generateIndex(e) {
    //传入的节点是否是'H1'或'H2'或'H3'
    if (titleTag.includes(e.nodeName)) {
        //获取该节点内的文本
        let result = e.textContent;
        //将该节点的'id'属性设为其文本内容，方便使用<a>锚点跳转
        e.setAttribute('id', result);
        //将该节点相关信息放入'titles'收集起来
        titles.push({
            //该节点的'id'标签及其值用于<a>锚点跳转
            id: result,
            //取该节点的节点名最后一位以提供缩进信息，如'H1'取'1','H2'取'2'
            level: e.nodeName.substring(1),
            //该节点文本内容
            title: result,
        });
    }
}
```
- Html文件中加入：

```HTML
&lt;div id="category">&lt;/div>
```

- 调用函数并使用 `titles` 中的信息拼接生成目录
```JAVASCRIPT
//调用函数得到 'titles' 数组
nodeTraverse(nodeToBeTraversed, generateIndex);

//使用 'titles' 数组中的信息拼接生成目录
for (let index in titles) {
        document.querySelector('#category').innerHTML +=
            //根据'level'设置缩进
            "&lt;li class='index' style='padding-left: " + titles[index].level * 22 + "px;'>" +
            //根据'id'设置跳转锚点
            "&lt;a href='#" + titles[index].id + "'>" +
            //根据'title'设置文本内容
            titles[index].title +
            '&lt;/a>&lt;/li>';
}
```

- 简单设置样式：
```CSS
#category {
    position: fixed;
    right: 4%;
    top: 35%;
    transition: 0.2s;
}

.index{
    margin: 10px 10px 10px 15px;
    font-size: 15px;
    font-weight: bolder;
    list-style-type: none;
}

#category a {
    text-decoration: none;
    color: #00000065;
    transition: 0.5s;
}

/* 状态三: 鼠标划过(停留)的链接(默认红色) */
#category a:hover {
    text-decoration: none;
    color: #000000;
    transition: 0.5s;
}
```

## 完整代码如下：

### index.html 文件如下:

```HTML
&lt;!DOCTYPE html>
&lt;html>
    &lt;head>
        &lt;meta charset="utf-8" />
        &lt;title>Markdown to Html&lt;/title>
        &lt;!-- 引入markdown-it.js -->
        &lt;script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js">&lt;/script>
        &lt;!-- 引入样式表文件 -->
        &lt;link href="./assets/css/github-markdown.css" rel="stylesheet" />
        &lt;!-- 调用markdown-it.js解析md格式原文,内容见后文 -->
        &lt;script src="./assets/js/MdToHtm.js" defer="defer">&lt;/script>
    &lt;/head>
    &lt;body>
        &lt;div class="markdown-body" id="raw-markdown-body">
        &lt;!-- markdown格式内容 -->
        &lt;/div>
        &lt;div id="category">&lt;/div>
    &lt;/body>
&lt;/html>
```

### MdToHtm.js 文件如下:
```JAVASCRIPT
//将markdown语法的内容转换为html格式的文件
{
    //加载markdown-it
    let MarkdownIt = window.markdownit({
        html: true,//启用解析md原文中html标签的功能
        linkify: true,//启用将类似url格式的文本解析为链接的功能
        typographer: true,//启用对一些符号进行替换的功能
        //另还有xhtmlOut, breaks, langPrefix, quotes等选项可以调整
        //详见文档 https://markdown-it.github.io/markdown-it/
    });

    //获取html文件中md格式原文
    let text = document.querySelector('#raw-markdown-body').textContent,
        //获取解析后的html格式文本应传入的目标节点
        target = document.querySelector('#raw-markdown-body'),
        //调用函数解析md原文
        result = MarkdownIt.render(text);
    //解析后的html格式文本传入目标节点
    target.innerHTML = result;
}

//根据文章结构生成目录
{
    //要匹配的html标签名
    let titleTag = ['H1', 'H2', 'H3'];
    //准备收集匹配到的节点
    let titles = [];
    //传给遍历函数第一个参数的父节点
    let nodeToBeTraversed = document.querySelector('#markdown-body');

    //传入两个参数，第一个参数为被遍历节点，第二个参数为一个处理节点并生成目录的函数，定义见后文
    function nodeTraverse(e, f) {
        //首先处理父节点
        f(e);
        //如果父节点有子节点
        if (e.hasChildNodes()) {
            //将父节点的所有子节点收集起来，e.childNodes返回一个nodeList类数组对象
            let children = e.childNodes;
            //遍历刚刚得到的子节点列表
            for (let i = 0; i < children.length; i++) {
                //递归，对每个子节点重复执行上述操作
                nodeTraverse(children[i], f);
            }
        }
    }

    //传入一个节点
    function generateIndex(e) {
        //传入的节点是否是'H1'或'H2'或'H3'
        if (titleTag.includes(e.nodeName)) {
            //获取该节点内的文本
            let result = e.textContent;
            //将该节点的'id'属性设为其文本内容，方便使用<a>锚点跳转
            e.setAttribute('id', result);
            //将该节点相关信息放入'titles'收集起来
            titles.push({
                //该节点的'id'标签及其值用于<a>锚点跳转
                id: result,
                //取该节点的节点名最后一位以提供缩进信息，如'H1'取'1','H2'取'2'
                level: e.nodeName.substring(1),
                //该节点文本内容
                title: result,
            });
        }
    }

    nodeTraverse(nodeToBeTraversed, generateIndex);

    //使用 'titles' 数组中的信息拼接生成目录
    for (let index in titles) {
            document.querySelector('#category').innerHTML +=
                //根据'level'设置缩进
                "&lt;li class='index' style='padding-left: " + titles[index].level * 22 + "px;'>" +
                //根据'id'设置跳转锚点
                "&lt;a href='#" + titles[index].id + "'>" +
                //根据'title'设置文本内容
                titles[index].title +
                '&lt;/a>&lt;/li>';
    }
}
```

### MdPassage.css 文件如下:

```CSS
#category {
    position: fixed;
    right: 4%;
    top: 35%;
    transition: 0.2s;
}

.index{
    margin: 10px 10px 10px 15px;
    font-size: 15px;
    font-weight: bolder;
    list-style-type: none;
}

#category a {
    text-decoration: none;
    color: #00000065;
    transition: 0.5s;
}

/* 状态三: 鼠标划过(停留)的链接(默认红色) */
#category a:hover {
    text-decoration: none;
    color: #000000;
    transition: 0.5s;
}
```

### github-markdown.css 文件

见 https://github.com/sindresorhus/github-markdown-css

## 附录

### 常用html转义字符:


|  字符   | 十进制  | 转义字符  |
|  ----  | ----  | ----  |
| "  | &amp;#34\; | &amp;quot\; |
| &  | &amp;#38\; | &amp;amp\; |
| &lt;  | &amp;#60\; | &amp;lt\; |


            </div>
        </div>
        <div id="category"></div>
        <!-- <div id="currentlyReading" style="min-height: 60px; width: 100%; position: fixed; top: 35%; background-color: aliceblue;"></div> -->
    </body>
</html>
